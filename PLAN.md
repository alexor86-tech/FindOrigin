# План реализации Telegram-бота FindOrigin

## Этап 1: Настройка проекта и окружения

1.1. Инициализация Next.js проекта
- Создать Next.js приложение с TypeScript
- Настроить структуру папок (app или pages router)
- Установить необходимые зависимости

1.2. Настройка переменных окружения
- Создать `.env.local` для хранения:
  - `TELEGRAM_BOT_TOKEN` - токен бота от BotFather
  - `TELEGRAM_API_URL` - базовый URL Telegram API
  - `AI_API_KEY` - ключ для AI сервиса (OpenAI/Anthropic/etc)
  - `WEBHOOK_SECRET` - секрет для верификации webhook (опционально)

1.3. Настройка конфигурации Vercel
- Создать `vercel.json` для настройки маршрутизации
- Настроить переменные окружения в Vercel dashboard

## Этап 2: Реализация Webhook для Telegram

2.1. Создание API route для webhook
- Создать endpoint `/api/webhook` (POST)
- Реализовать быструю валидацию входящего запроса
- Извлечение `chat.id` и `text` из `update.message`
- Возврат 200 OK сразу после получения запроса

2.2. Обработка асинхронных задач
- Настроить очередь задач или фоновую обработку
- Отправка ответа пользователю после завершения обработки

2.3. Обработка ошибок
- Реализовать обработку некорректных запросов
- Логирование ошибок

## Этап 3: Извлечение текста из сообщений

3.1. Обработка текстовых сообщений
- Парсинг обычного текста из `update.message.text`

3.2. Обработка ссылок на Telegram-посты
- Определение формата ссылки (t.me/channel/123 или t.me/channel/123?thread=456)
- Реализация функции извлечения текста из Telegram-поста:
  - Использование Telegram Bot API для получения поста по ID
  - Парсинг текста, подписей к медиа, пересылаемых сообщений

3.3. Валидация входных данных
- Проверка наличия текста или ссылки
- Обработка пустых сообщений

## Этап 4: Извлечение ключевой информации из текста

4.1. Реализация парсера для выделения сущностей:
- Ключевые утверждения (предложения с фактами, заявлениями)
- Даты (различные форматы: DD.MM.YYYY, YYYY-MM-DD, относительные даты)
- Числа (статистика, проценты, суммы)
- Имена (имена людей, организаций, географические названия)
- Ссылки (URL в тексте)

4.2. Использование NLP библиотек
- Интеграция библиотеки для NER (Named Entity Recognition)
- Возможно использование AI для более точного извлечения сущностей

4.3. Нормализация извлеченных данных
- Приведение дат к единому формату
- Очистка и нормализация имен и названий

## Этап 5: Поиск возможных источников

5.1. Реализация поисковых запросов
- Формирование поисковых запросов на основе извлеченных сущностей
- Комбинация ключевых слов, дат, имен для эффективного поиска

5.2. Интеграция поисковых API
- Выбор поискового API (Google Custom Search, Bing Search API, или другие)
- Реализация функции поиска с фильтрацией по типам источников:
  - Официальные сайты (gov, org, официальные домены)
  - Новостные сайты (news, медиа-ресурсы)
  - Блоги (blog, medium, и т.д.)
  - Исследования (academic, research, scholar)

5.3. Обработка результатов поиска
- Сбор результатов из разных источников
- Фильтрация дубликатов
- Ограничение количества результатов для анализа

## Этап 6: AI-сравнение и оценка релевантности

6.1. Интеграция AI сервиса
- Выбор AI модели (OpenAI GPT, Anthropic Claude, или другие)
- Настройка промптов для сравнения смысла текста

6.2. Реализация функции сравнения
- Сравнение исходного текста с найденными источниками
- Анализ смысловой близости, а не буквального совпадения
- Учет контекста и перефразирования

6.3. Система оценки уверенности
- Разработка метрики уверенности (0-100% или 0-1)
- Учет факторов:
  - Смысловое совпадение
  - Надежность источника
  - Временная релевантность
  - Количество подтверждений

6.4. Ранжирование результатов
- Сортировка источников по оценке уверенности
- Отбор топ-3 результатов для отправки пользователю

## Этап 7: Форматирование и отправка ответа

7.1. Форматирование результатов
- Создание читаемого формата ответа:
  - Заголовок/описание источника
  - Ссылка на источник
  - Оценка уверенности (в процентах или текстовом виде)
  - Краткое объяснение релевантности

7.2. Использование Telegram форматирования
- Применение Markdown или HTML для форматирования
- Добавление эмодзи для визуального улучшения

7.3. Отправка ответа через Telegram API
- Реализация функции `sendMessage` через Telegram Bot API
- Обработка ошибок отправки
- Retry логика при временных сбоях

## Этап 8: Дополнительные функции и улучшения

8.1. Обработка различных типов сообщений
- Поддержка медиа-сообщений с подписями
- Обработка пересылаемых сообщений
- Поддержка групповых чатов

8.2. Команды бота
- `/start` - приветственное сообщение и инструкции
- `/help` - справка по использованию бота
- Возможно `/settings` для настройки параметров поиска

8.3. Обработка длинных текстов
- Разбиение длинных текстов на части
- Обработка ограничений по длине сообщений Telegram

8.4. Кэширование результатов
- Кэширование результатов поиска для одинаковых запросов
- Использование базы данных или кэша (Redis, Vercel KV)

## Этап 9: Тестирование

9.1. Unit тесты
- Тесты для функций извлечения сущностей
- Тесты для парсинга Telegram ссылок
- Тесты для форматирования ответов

9.2. Integration тесты
- Тесты webhook endpoint
- Тесты интеграции с Telegram API
- Тесты интеграции с поисковыми API

9.3. Ручное тестирование
- Тестирование различных типов входных данных
- Проверка работы с реальными Telegram-постами
- Тестирование в различных сценариях использования

## Этап 10: Деплой и мониторинг

10.1. Деплой на Vercel
- Настройка webhook URL в Telegram Bot API
- Проверка доступности endpoint
- Тестирование работы webhook

10.2. Настройка мониторинга
- Логирование важных событий
- Настройка алертов на ошибки
- Мониторинг производительности

10.3. Оптимизация
- Оптимизация времени ответа
- Оптимизация использования API квот
- Оптимизация стоимости AI запросов

## Этап 11: Документация и финализация

11.1. Создание документации
- Обновление README.md с инструкциями по установке и использованию
- Документация API endpoints
- Комментарии в коде

11.2. Финальная проверка
- Проверка соответствия спецификации из PROJECT.md
- Проверка обработки edge cases
- Финальное тестирование всех функций
